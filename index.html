<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Housekeeping Task Tracker</title>
  <style>
    :root{
      --bg:#1e2a5a; --card:#fff; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --brand:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;padding:24px}
    .wrap{max-width:1100px;margin:0 auto;background:var(--card);border-radius:16px;box-shadow:0 20px 40px rgba(2,6,23,.25);overflow:hidden}
    header{padding:28px;border-bottom:1px solid var(--line);background:linear-gradient(#243042,#243042) top/100% 140px no-repeat}
    h1{margin:0;color:#fff;font-weight:800;letter-spacing:.02em;text-align:center}
    .subtitle{color:#d1d5db;text-align:center;margin-top:6px}
    nav{display:flex;justify-content:center;gap:12px;margin-top:16px}
    .tab{padding:10px 16px;border-radius:999px;border:1px solid #3b4250;background:#3b4250;color:#cbd5e1;cursor:pointer}
    .tab.active{background:#60a5fa;border-color:#60a5fa;color:#062945;font-weight:700}
    main{padding:22px}

    /* form layout */
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .field{flex:1 1 280px;display:flex;flex-direction:column;gap:6px}
    .label{font-size:12px;color:#334155;font-weight:600}
    select,input[type=date]{height:38px;padding:0 10px;border:1px solid #d1d5db;border-radius:8px}
    .hint{margin:18px 0 8px;color:#64748b;text-align:center}
    .sectionTitle{margin:14px 0 8px;padding:12px 16px;background:#eef2ff;border-left:4px solid var(--brand);font-weight:700;letter-spacing:.03em}
    .tasks{display:flex;flex-direction:column;gap:10px}
    .task{display:flex;gap:10px;align-items:flex-start;padding:12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    .actions{display:flex;gap:10px;justify-content:center;margin:18px 0}
    .btn{padding:10px 14px;border-radius:8px;border:1px solid #d1d5db;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#e5e7eb;color:#111827}
    .success{display:none;margin:14px auto 0;max-width:680px;background:#dcfce7;border:1px solid #86efac;color:#14532d;padding:10px 14px;border-radius:8px;text-align:center}

    /* manager */
    .toolbar{display:flex;gap:12px;align-items:end;flex-wrap:wrap;margin:10px 0 20px}
    .btn-link{padding:8px 12px;border:1px solid #cbd5e1;background:#f8fafc;border-radius:8px;cursor:pointer}
    .cards{display:flex;flex-direction:column;gap:12px}
    .card{border:1px solid #e5e7eb;border-left-width:6px;border-radius:12px;padding:12px 14px;background:#fff}
    .card .top{display:flex;justify-content:space-between;gap:10px}
    .badge{font-weight:800;padding:6px 10px;border-radius:999px;color:#fff}
    .b-ok{background:var(--ok)} .b-warn{background:var(--warn)} .b-bad{background:var(--bad)}
    details{margin-top:6px}
    .muted{color:#6b7280}
    @media (max-width:640px){ header{padding:20px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="title">Housekeeping Task Tracker</h1>
      <div class="subtitle">CHESTERMAN GROUP CORP — Housekeeping Task Tracker 2025</div>
      <nav>
        <button id="tabForm" class="tab active">Housekeeper Form</button>
        <button id="tabMgr" class="tab">Manager Dashboard</button>
      </nav>
    </header>

    <main>
      <!-- ================= Housekeeper Form ================= -->
      <section id="panelForm">
        <div class="row">
          <div class="field">
            <label class="label">Housekeeper</label>
            <select id="housekeeper"></select>
          </div>
          <div class="field">
            <label class="label">Shift</label>
            <select id="shift"></select>
          </div>
          <div class="field">
            <label class="label">Date</label>
            <input id="date" type="date"/>
          </div>
        </div>

        <div id="hint" class="hint">Please select a shift to see the tasks</div>
        <div id="tasks" class="tasks"></div>

        <div class="actions">
          <button id="submit" class="btn">Submit Daily Tasks</button>
          <button id="clear" class="btn secondary">Clear checks</button>
        </div>
        <div id="success" class="success">Tasks submitted successfully! ✅</div>
        <div class="muted" style="text-align:center;margin-top:8px">
          Unchecked items will be logged to <b>Incomplete Tasks</b> in the sheet.
        </div>
      </section>

      <!-- ================= Manager Dashboard ================= -->
      <section id="panelMgr" style="display:none">
        <div class="toolbar">
          <div class="field" style="flex:1 1 200px">
            <label class="label">Housekeeper</label>
            <select id="filterKeeper"><option value="">All Housekeepers</option></select>
          </div>
          <div class="field" style="flex:1 1 200px">
            <label class="label">Shift</label>
            <select id="filterShift">
              <option value="">All Shifts</option>
              <option value="morning">Morning</option>
              <option value="middle">Middle</option>
              <option value="evening">Evening</option>
            </select>
          </div>
          <div class="field" style="flex:1 1 160px">
            <label class="label">Date</label>
            <input id="filterDate" type="date"/>
          </div>
          <button id="openSheet" class="btn-link" title="Open in Google Sheets">Open in Google Sheets</button>
          <button id="clearFilters" class="btn-link">Clear Filters</button>
        </div>

        <div id="cards" class="cards"><div class="muted">Loading…</div></div>
      </section>
    </main>
  </div>

  <script>
  (function () {
    // ======== CONFIG (edit these for each property) ========
    const SITE_TITLE = "140 W 11th – Housekeeping Task Tracker";
    const FUNCTION_URL = "/.netlify/functions/submissions"; // Netlify function path
    const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/1-2paA8-qALzx1QKVe4S37im_HtL7TWn4yiheIT5AygM/edit?gid=0#gid=0"

    const HOUSEKEEPERS = ["JACKY","KUNGA","LORENA","HEIDI","ANA","IRMA","AGNES","ANITA"];
    const SHIFTS = [
      { value:"morning", label:"Morning Shift — 7:30 am" },
      { value:"middle",  label:"Middle Shift — 1:00 pm" },
      { value:"evening", label:"Evening Shift — 5:00 pm" },
    ];
    // One-column form: list items under each shift (customize!)
    const SHIFT_TASKS = {
      morning: [
        "Turn lights on (or off exteriors)",
        "Check Ms. Office; fresh water",
        "Set the table for kids' breakfast",
        "Empty dishwashers",
        "Walk the dogs then feed",
        "Check dining room from night prior",
        "Quick walk through the house",
        "Flowers — add water or change (2 people)",
        "Assist with family breakfast",
        "Clean up after breakfast",
        "Receive and display packages",
        "Check bathroom on kitchen floor",
        "Clean Oli's room/bathroom",
        "Clean Frankie's room/bathroom",
        "Clean Sonnet's room (if applicable)",
        "Collect laundry → bring to laundry room",
        "Clean Master if available",
        "Clean kids' lounge/sun room",
        "Clean kids' 3rd floor hallways",
        "Clean kids' room; organize closets",
        "Clean & organize Caddy; replace tools"
      ],
      middle: ["Middle shift task 1","Middle shift task 2","Middle shift task 3"],
      evening: ["Evening shift task 1","Evening shift task 2"]
    };

    // ======== DOM HOOKS ========
    const els = {
      title: document.getElementById("title"),
      tabForm: document.getElementById("tabForm"),
      tabMgr:  document.getElementById("tabMgr"),
      panelForm: document.getElementById("panelForm"),
      panelMgr:  document.getElementById("panelMgr"),

      housekeeper: document.getElementById("housekeeper"),
      shift: document.getElementById("shift"),
      date: document.getElementById("date"),
      hint: document.getElementById("hint"),
      tasks: document.getElementById("tasks"),
      submit: document.getElementById("submit"),
      clear: document.getElementById("clear"),
      success: document.getElementById("success"),

      filterKeeper: document.getElementById("filterKeeper"),
      filterShift: document.getElementById("filterShift"),
      filterDate: document.getElementById("filterDate"),
      openSheet: document.getElementById("openSheet"),
      clearFilters: document.getElementById("clearFilters"),
      cards: document.getElementById("cards"),
    };

    // ======== INIT ========
    els.title.textContent = SITE_TITLE;
    els.date.valueAsNumber = Date.now() - (new Date()).getTimezoneOffset()*60000;

    // fill selects
    function fillLists() {
      if (els.housekeeper) {
        els.housekeeper.innerHTML = "";
        HOUSEKEEPERS.forEach(n => {
          const o = document.createElement("option"); o.value = o.textContent = n;
          els.housekeeper.appendChild(o);
        });
      }
      if (els.shift) {
        els.shift.innerHTML = "";
        SHIFTS.forEach(s => {
          const o = document.createElement("option"); o.value = s.value; o.textContent = s.label;
          els.shift.appendChild(o);
        });
      }
      if (els.filterKeeper) {
        els.filterKeeper.innerHTML = '<option value="">All Housekeepers</option>';
        HOUSEKEEPERS.forEach(n => {
          const o = document.createElement("option"); o.value = o.textContent = n;
          els.filterKeeper.appendChild(o);
        });
      }
      if (GOOGLE_SHEET_URL) {
        els.openSheet.onclick = () => window.open(GOOGLE_SHEET_URL, "_blank");
      } else {
        els.openSheet.style.display = "none";
      }
    }
    fillLists();

    // ======== FORM RENDERING ========
    function renderTasks() {
      els.tasks.innerHTML = "";
      const s = els.shift.value;
      if (!s) { els.hint.textContent = "Please select a shift to see the tasks"; els.hint.className = "hint"; return; }
      const items = SHIFT_TASKS[s] || [];
      const found = SHIFTS.find(x => x.value === s);
      els.hint.textContent = (found ? found.label.split("—")[0] : s).toUpperCase();
      els.hint.className = "hint sectionTitle";
      items.forEach((t, i) => {
        const row = document.createElement("label");
        row.className = "task";
        row.innerHTML = `<input type="checkbox" data-i="${i}"> <span>${t}</span>`;
        els.tasks.appendChild(row);
      });
    }
    els.shift.addEventListener("change", renderTasks);
    renderTasks();

    els.clear.addEventListener("click", () => {
      els.tasks.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false);
    });

    // ======== SUBMIT (writes to A:H) ========
    els.submit.addEventListener("click", async () => {
      const items = SHIFT_TASKS[els.shift.value] || [];
      const checks = Array.from(els.tasks.querySelectorAll('input[type=checkbox]'));
      const incomplete = items.filter((_, i) => !checks[i]?.checked);
      const payload = {
        date: els.date.value,
        housekeeper: els.housekeeper.value,
        shift: els.shift.value,
        completedCount: items.length - incomplete.length,
        totalTasks: items.length,
        completionRate: items.length ? Math.round(((items.length - incomplete.length) / items.length) * 100) : 0,
        submittedAt: new Date().toISOString(),
        incompleteList: incomplete     // backend accepts incompleteList or incomplete
      };
      const res = await fetch(FUNCTION_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if (res.ok) {
        els.success.style.display = "block";
        setTimeout(()=> els.success.style.display = "none", 2500);
        loadManager(); // refresh dashboard
      } else {
        alert("Submit failed");
      }
    });

    // ======== MANAGER DASHBOARD ========
    async function fetchSubmissions() {
      const r = await fetch(FUNCTION_URL);
      const payload = await r.json();
      return Array.isArray(payload) ? payload : (payload.submissions || []);
    }

    function badgeClass(pct){
      if (pct >= 90) return "b-ok";
      if (pct >= 70) return "b-warn";
      return "b-bad";
    }

    function passesFilters(row){
      if (els.filterKeeper.value && row.housekeeper !== els.filterKeeper.value) return false;
      if (els.filterShift.value && row.shift !== els.filterShift.value) return false;
      if (els.filterDate.value && row.date !== els.filterDate.value) return false;
      return true;
    }

    async function loadManager() {
      els.cards.innerHTML = '<div class="muted">Loading…</div>';
      try{
        const rows = (await fetchSubmissions()).filter(passesFilters);
        if (!rows.length) { els.cards.innerHTML = '<div class="muted">No rows</div>'; return; }
        els.cards.innerHTML = rows.map(s => {
          const pct = s.completionRate === "" ? "" : Number(s.completionRate);
          const badge = pct === "" ? "" : `<span class="badge ${badgeClass(pct)}">${s.completedCount}/${s.totalTasks} tasks (${pct}%)</span>`;
          const inc = Array.isArray(s.incompleteList) ? s.incompleteList
                    : String(s.incompleteList || s.incomplete || "").split(/;\s*|,\s*/).filter(Boolean);
          return `
            <div class="card" style="border-left-color:#60a5fa">
              <div class="top">
                <div><b>${(s.housekeeper || "").toUpperCase()}</b> — ${(s.shift || "").toUpperCase()}<br>
                  <span class="muted">Date: ${s.date || ""} • Submitted: ${(s.submittedAt || "").replace('T',' ').replace('Z','')}</span>
                </div>
                <div>${badge}</div>
              </div>
              <details>
                <summary>View Incomplete Tasks</summary>
                <ul style="margin:8px 0 0 18px">${inc.length ? inc.map(t=>`<li>${t}</li>`).join("") : "<li>None 🎉</li>"}</ul>
              </details>
            </div>
          `;
        }).join("");
      }catch(e){
        els.cards.innerHTML = `<div class="muted">Error loading: ${e.message}</div>`;
      }
    }

    // filters
    els.clearFilters.addEventListener("click", ()=>{
      els.filterKeeper.value = "";
      els.filterShift.value = "";
      els.filterDate.value = "";
      loadManager();
    });
    [els.filterKeeper, els.filterShift, els.filterDate].forEach(el => el?.addEventListener("change", loadManager));

    // tab switching
    els.tabForm.addEventListener("click", ()=>{
      els.tabForm.classList.add("active"); els.tabMgr.classList.remove("active");
      els.panelForm.style.display="block";  els.panelMgr.style.display="none";
    });
    els.tabMgr.addEventListener("click", ()=>{
      els.tabMgr.classList.add("active"); els.tabForm.classList.remove("active");
      els.panelMgr.style.display="block";   els.panelForm.style.display="none";
      loadManager();
    });
  })();
  </script>
</body>
</html>
